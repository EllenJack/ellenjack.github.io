<!doctype html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no">
    
    
    <!--Simple SEO-->

<meta name="description" content="程序员的梦工厂/">


<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">
    <!--Title-->

<title>K8S基础操作 | 小小杰博客</title>

<link rel="alternate" href="/atom.xml" title="小小杰博客" type="application/atom+xml">


<link rel="icon" href="/favicon.ico">

    
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/css/pages/post.css">
<link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/thirdParty/highlight/github.css">


    <!--script-->



<!--<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>-->



    
    
</head>
</html>
<body id="normal">
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<style>
    header{ top: 71px; position: absolute!important;}
    #container{padding-top: 151px!important;}
</style>
<div style="position:fixed;z-index:9999;left:0;top:0;width:100%;height:70px;background-color:#e0e0e0;color:#396CA5;border-bottom:1px solid #cecece;text-align:center;line-height:70px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<div id="wrap">
    <header style="position: absolute;">
    <div id="site-meta">
        <a href="/" id="logo">
            <h1 class="title">小小杰博客</h1>
        </a>
        
        <h2 class="subtitle">代码改变世界</h2>
        
    </div>
    <ul id="nav">
        
            <li><a href="/"><i class="fa fa-home"></i>首页</a></li>
        
            <li><a href="/2018/12/15/about/"><i class="fa fa-user"></i>关于我</a></li>
        
            <li><a href="/atom.xml"><i class="fa fa-rss"></i>RSS</a></li>
        
        <li id="search"><a href="javascript:void(0)"><i class="fa fa-search"></i>搜索</a></li>
    </ul>
</header>

    <div id="container">
        
<ul id="sidebar">
    
    
<li class="widget notification">
    <i class="fa fa-bell-o"></i>
    <div>
        
<p>学而时习之，不亦乐乎</p>
    </div>
</li>

    
    
<li class="widget widget-normal category">
    <h3 class="fa fa-th widget-title">分类</h3>
    <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/并发编程/"><i class="fa" aria-hidden="true">并发编程</i></a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/框架/"><i class="fa" aria-hidden="true">框架</i></a><span class="category-list-count">10</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/框架/Spring/"><i class="fa" aria-hidden="true">Spring</i></a><span class="category-list-count">10</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/消息中间件/"><i class="fa" aria-hidden="true">消息中间件</i></a><span class="category-list-count">5</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/消息中间件/Kafka/"><i class="fa" aria-hidden="true">Kafka</i></a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/消息中间件/RabbitMQ/"><i class="fa" aria-hidden="true">RabbitMQ</i></a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link current" href="/categories/物理部署/"><i class="fa" aria-hidden="true">物理部署</i></a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/"><i class="fa" aria-hidden="true">随笔</i></a><span class="category-list-count">5</span></li></ul>
</li>


    
    
<li class="widget widget-normal archive">
  <h3 class="fa fa-archive widget-title">时光轴</h3>
    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/"><i class="fa" aria-hidden="true">六月 2020</i></a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/"><i class="fa" aria-hidden="true">四月 2020</i></a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/"><i class="fa" aria-hidden="true">七月 2019</i></a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/"><i class="fa" aria-hidden="true">六月 2019</i></a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/"><i class="fa" aria-hidden="true">三月 2019</i></a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/"><i class="fa" aria-hidden="true">二月 2019</i></a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/"><i class="fa" aria-hidden="true">十二月 2018</i></a><span class="archive-list-count">5</span></li></ul>
</li>


    
    

    
    
<li class="widget widget-normal tags">
  <h3 class="fa fa-tags widget-title">标签云</h3>
  <div class="tagcloud-content">
    
      <a href="/tags/类加载/" style="font-size: 0.14rem; color: #69c">类加载</a> <a href="/tags/docker/" style="font-size: 0.16rem; color: #4f83b8">docker</a> <a href="/tags/事务/" style="font-size: 0.14rem; color: #69c">事务</a> <a href="/tags/关于我/" style="font-size: 0.14rem; color: #69c">关于我</a> <a href="/tags/jvm/" style="font-size: 0.14rem; color: #69c">jvm</a> <a href="/tags/k8s/" style="font-size: 0.16rem; color: #4f83b8">k8s</a> <a href="/tags/索引/" style="font-size: 0.14rem; color: #69c">索引</a> <a href="/tags/Kafka/" style="font-size: 0.17rem; color: #386da4">Kafka</a> <a href="/tags/Maven/" style="font-size: 0.14rem; color: #69c">Maven</a> <a href="/tags/Spring/" style="font-size: 0.2rem; color: #0a407c">Spring</a> <a href="/tags/RabbitMQ/" style="font-size: 0.14rem; color: #69c">RabbitMQ</a> <a href="/tags/多线程/" style="font-size: 0.18rem; color: #215690">多线程</a>
  </div>
</li>


    
    
<li class="widget widget-normal friends-link">
    <h3 class="fa fa-globe widget-title">友情链接</h3><br>

    
        <a href="https://qkongtao.cn" class="fa" target="_blank">另一个世界</a>

    
        <a href="http://wuwenliang.net" class="fa" target="_blank">朝·闻·道</a>

    
        <a href="https://pleuvoir.github.io" class="fa" target="_blank">撄而后成</a>

    

</li>


    
</ul>


        <div id="main">
    <article id="post">
        <div id="post-header">

            <h1 id="K8S基础操作">
                
                K8S基础操作
                
            </h1>
            <div class="article-meta">
    
    
    <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
        <span>物理部署</span>
    </span>
    
    
    <span class="fa-wrap">
         <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
            k8s
            
        </span>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-clock-o"></i>
        <span class="date-meta ">2020/06/27</span>
    </span>
    
    
    
</div>

            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>878</strong>天之前发表，文中内容可能已经过时。如有疑问，请在评论区留言。
            </p>
            
        </div>
        
        <div id="post-body">
            <h2 id="1-1-kubectl的命令用法"><a href="#1-1-kubectl的命令用法" class="headerlink" title="1.1 kubectl的命令用法"></a>1.1 kubectl的命令用法</h2><p>可以借助kubectl -h命令学习用法，下面介绍常用的一些命令使用：</p>
<h3 id="1-1-1-kubectl-run，创建一个应用程序"><a href="#1-1-1-kubectl-run，创建一个应用程序" class="headerlink" title="1.1.1 kubectl run，创建一个应用程序"></a>1.1.1 kubectl run，创建一个应用程序</h3><p>kubectl run nginx-dep –image=nginx:1.7.9 –port=80 –replicas=2 </p>
<p>可以先测试：–dry-run</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg739xsktbj30n201wq3f.jpg" alt></p>
<p>正式创建：</p>
<p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73a91do0j30n2034dgi.jpg" alt></p>
<p>查看服务信息：</p>
<p>kubectl get pods -o wide  </p>
<p>#获取pod的信息，-o wide 表示更详细的显示信息</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73adfk28j30n201q0t2.jpg" alt> </p>
<p>看到系统里启动了两个pod服务（运行nginx），分别运行在节点node2和node3上</p>
<p>测试nginx服务，服务ok</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73b1cxv3j30n207uaat.jpg" alt></p>
<h3 id="1-1-2-探究pod详情："><a href="#1-1-2-探究pod详情：" class="headerlink" title="1.1.2 探究pod详情："></a>1.1.2 探究pod详情：</h3><p>kubectl describe pod nginx-dep-5779c9d6c9-cwjth</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73b6u4rtj30n2084abi.jpg" alt> </p>
<p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73bd0iw3j30n20363z7.jpg" alt></p>
<p>进入容器查看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">格式：``kubectl exec` `-it podName -c containerName -n namespace -- shell comand</span><br></pre></td></tr></table></figure>
<p>kubectl exec -it nginx-dep-5779c9d6c9-cwjth -c nginx-dep /bin/bash</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73bhabihj30n201ydgd.jpg" alt> </p>
<h3 id="1-1-3-暴露服务到外网"><a href="#1-1-3-暴露服务到外网" class="headerlink" title="1.1.3 暴露服务到外网"></a>1.1.3 暴露服务到外网</h3><p>将pod创建完成后，访问该pod内的服务只能在集群内部通过pod的的地址去访问该服务；当该pod出现故障后，该pod的控制器会重新创建一个包括该服务的pod,此时访问该服务须要获取该服务所在的新的pod的地址ip去访问。</p>
<p>#删除当前的pod:</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73bne7o2j30n2050403.jpg" alt> </p>
<p>如何保持pod的故障恢复，对调用者无影响呢？</p>
<p>可以创建一个service，当新的pod的创建完成后，service会通过pod的label连接到该服务，只需通过service即可访问该服务。</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73bth82tj30n208qmz0.jpg" alt> </p>
<p>查看svc的label配置</p>
<p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73c2te4rj30n207mgmq.jpg" alt></p>
<p>上述方式，虽然能够通过service访问到pod服务。但在集群外部，是无法访问到的，如在本地windows机器上，想要访问到nginx服务，网络是不通的。我们可以修改service的类型的NodePort。</p>
<p>kubectl edit svc nginx-svc</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73c75xhcj30n20c875u.jpg" alt> </p>
<p>查看绑定端口</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73cew9h5j30n202w74s.jpg" alt> </p>
<p>在外部可以通过node节点的地址及该端口访问pod内的服务。</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73cio6pjj30n207q757.jpg" alt> </p>
<h3 id="1-1-4-服务的伸缩"><a href="#1-1-4-服务的伸缩" class="headerlink" title="1.1.4 服务的伸缩"></a>1.1.4 服务的伸缩</h3><p>Pod创建完成后，当服务的访问量过大时，可以对pod的进行扩展让pod中的服务处理更多的请求；当访问量减小时，可以缩减pod数量，以节约资源。 这些操作都可以在线完成，并不会影响现有的服务。</p>
<p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73cmny7vj30n203a3zg.jpg" alt></p>
<p>缩减服务雷同</p>
<h3 id="1-1-5-服务的在线升级与回滚"><a href="#1-1-5-服务的在线升级与回滚" class="headerlink" title="1.1.5 服务的在线升级与回滚"></a>1.1.5 服务的在线升级与回滚</h3><p>在kubernetes服务中部署完服务后，对服务的升级可以在线完成，升级出问题后，也可以在线完成回滚。、</p>
<p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73cr465nj30n208s75p.jpg" alt></p>
<p>可以看到滚动更新的过程：</p>
<p>kubectl get pod -w  ##w参数是watch，持续执行，并观察改变</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73cxdoxtj30n20aiad0.jpg" alt> </p>
<p>再次查看镜像版本</p>
<p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73d2uwqpj30n2088q4c.jpg" alt></p>
<p>还可以再回滚回原来的版本：</p>
<p>kubectl rollout undo deployment nginx-dep</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73d9zfugj30n208u0vb.jpg" alt> </p>
<p>查看版本，又回到1.7.9的版本</p>
<p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73dd3bw4j30n208qq4d.jpg" alt></p>
<h2 id="1-2-YAML文件管理资源"><a href="#1-2-YAML文件管理资源" class="headerlink" title="1.2 YAML文件管理资源"></a>1.2 YAML文件管理资源</h2><p>K8s两种创建资源的方式：</p>
<p>　　（1）用kubectl命令的方式直接创建：比如前面的创建deployment</p>
<p>　　（2）通过配置文件和kubectl apply创建，</p>
<p>正式的使用，一般采用第二种方式</p>
<h3 id="1-2-1-资源清单的格式"><a href="#1-2-1-资源清单的格式" class="headerlink" title="1.2.1 资源清单的格式"></a>1.2.1 资源清单的格式</h3><p>apiVersion: group/apiversion # 不指定定group，默认为croe</p>
<p>kind:    #资源类别</p>
<p>metadata： #资源元数据</p>
<p>  name</p>
<p>  namespace #k8s自身的namespace</p>
<p>  lables</p>
<p>  annotations  #主要目的是方便用户阅读查找</p>
<p>spec:期望的状态（disired state）</p>
<p>status：当前状态，本字段有kubernetes自身维护，用户不能去定义</p>
<p>  •缩进表示层级关系</p>
<p>​    •不支持制表符“tab”缩进，使用空格缩进</p>
<p>​    •通常开头缩进2 个空格</p>
<p>​    •字符后缩进1 个空格，如冒号、逗号等</p>
<p>​    •“—” 表示YAML格式，一个文件的开始</p>
<p>  •“#”注释</p>
<h3 id="1-2-2-创建deployment"><a href="#1-2-2-创建deployment" class="headerlink" title="1.2.2 创建deployment"></a>1.2.2 创建deployment</h3><p># vi nginx-deployment.yaml </p>
<p>apiVersion: apps/v1       # 配置格式的版本      </p>
<p>kind: Deployment                # 创建的资源类型，这里是deployment</p>
<p>metadata:                    # 元数据</p>
<p> name: nginx-deployment</p>
<p> namespace: default</p>
<p>spec:</p>
<p> replicas: 2</p>
<p> selector:</p>
<p>  matchLabels:</p>
<p>   app: nginx</p>
<p> template:</p>
<p>  metadata:</p>
<p>   labels:</p>
<p>​    app: nginx</p>
<p>  spec:</p>
<p>   containers:</p>
<p>   - name: nginx</p>
<p>​    image: nginx:1.7.9</p>
<p>​    ports:</p>
<p>​    - containerPort: 80</p>
<p>此文件定义内容，效果与上一节中的命令方式相同。但配置更为详尽</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#使用create 子命令以yaml文件的方式启动</span><br><span class="line">kubectl create -f nginx-deployment.yaml</span><br></pre></td></tr></table></figure>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73e8d7vlj30n204aq9u.jpg" alt="image-20200627195420189"></p>
<h3 id="1-2-3-扩容伸缩"><a href="#1-2-3-扩容伸缩" class="headerlink" title="1.2.3 扩容伸缩"></a>1.2.3 扩容伸缩</h3><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73ewitxpj30n20aoq40.jpg" alt></p>
<p>使用kubectl apply生效</p>
<p>kubectl apply -f nginx-deployment.yaml </p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73ezxmbuj30n203emy1.jpg" alt> </p>
<h3 id="1-2-4-获取资源的apiVersion版本及资源配置的帮助"><a href="#1-2-4-获取资源的apiVersion版本及资源配置的帮助" class="headerlink" title="1.2.4 获取资源的apiVersion版本及资源配置的帮助"></a>1.2.4 获取资源的apiVersion版本及资源配置的帮助</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k8s中， 可以使用kubectl api-versions 获取当前k8s版本上所有的apiVersion版本信息(每个版本可能不同)</span><br></pre></td></tr></table></figure>
<p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73f6rf1uj30fo05cwew.jpg" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">可以看到出来，不同的资源属于不同的apiVersion版本</span><br></pre></td></tr></table></figure>
<p>你还可以查看资源的配置清单的二级级别的字段</p>
<p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73fctyugj30n207q0tl.jpg" alt></p>
<p>三级字段</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73fk0kpvj30n205uq3r.jpg" alt> </p>
<h3 id="1-2-5-使用service提供外部访问"><a href="#1-2-5-使用service提供外部访问" class="headerlink" title="1.2.5 使用service提供外部访问"></a>1.2.5 使用service提供外部访问</h3><p>vim nginx-service.yaml</p>
<p>apiVersion: v1</p>
<p>kind: Service</p>
<p>metadata:</p>
<p> name: nginx-service</p>
<p> labels:</p>
<p>  app: nginx</p>
<p>spec:</p>
<p> type: NodePort</p>
<p> ports:</p>
<p> - port: 80</p>
<p>  targetPort: 80</p>
<p> selector:</p>
<p>  app: nginx</p>
<p>创建：kubectl create -f nginx-svc.yaml </p>
<p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73fsdj80j30n203kmy0.jpg" alt></p>
<p>浏览器访问ok</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73fvnkgkj30n20780tk.jpg" alt> </p>
<h2 id="1-3-Pod控制器-kube-controller-manager"><a href="#1-3-Pod控制器-kube-controller-manager" class="headerlink" title="1.3 Pod控制器(kube-controller-manager)"></a>1.3 <a href="https://www.cnblogs.com/panwenbin-logs/p/9907847.html" target="_blank" rel="noopener">Pod控制器(kube-controller-manager)</a></h2><p>kube-controller-manager 是Kubernetes 的大脑， 它通过 apiserver 监控整个集群的状态， 并确保集群处于预期的工作状态。</p>
<h3 id="1-3-1-ReplicaSets控制器"><a href="#1-3-1-ReplicaSets控制器" class="headerlink" title="1.3.1 ReplicaSets控制器"></a>1.3.1 ReplicaSets控制器</h3><p>   k8s中最初有个Replication Controller ，它保证了在所有时间内，都有特定数量的Pod副本正在运行，如果太多了，Replication Controller就杀死几个，如果太少了，Replication Controller会新建几个，和直接创建的pod不同的是，Replication Controller会替换掉那些删除的或者被终止的pod，不管删除的原因是什么（维护阿，更新啊，Replication Controller都不关心）。基于这个理由，我们建议即使是只创建一个pod，我们也要使用Replication Controller。</p>
<p>   Replication Controller 就像一个进程管理器，监管着不同node上的多个pod,而不是单单监控一个node上的pod,Replication Controller 会委派本地容器来启动一些节点上服务（Kubelet ,Docker）。对于服务和用户来说，Replication Controller是通过一种无形的方式来维持着服务的状态</p>
<p>   ReplicaSet是加强版的Replication Controller，其功能只是扩展了Replication Controller的selector，支持基于集合的selector（version in (v1.0, v2.0)或env notin (dev, qa)），K8s中一般我们不再使用Replication Controller。</p>
<h3 id="1-3-2-Deployment控制器"><a href="#1-3-2-Deployment控制器" class="headerlink" title="1.3.2 Deployment控制器"></a>1.3.2 Deployment控制器</h3><p>   Deployment为Pod和Replica Set（下一代Replication Controller）提供声明式更新。意思就是，Replica Set一是在Deployment里使用的。</p>
<p>你只需要在Deployment中描述你想要的目标状态是什么，Deployment controller就会帮你将Pod和Replica Set的实际状态改变到你的目标状态。你可以定义一个全新的Deployment，也可以创建一个新的替换旧的Deployment。</p>
<p> 典型的用法：</p>
<p>1.使用Deployment来创建ReplicaSet。ReplicaSet在后台创建pod。检查启动状态，看它是成功还是失败。</p>
<p>2.然后，通过更新Deployment的PodTemplateSpec字段来声明Pod的新状态。这会创建一个新的ReplicaSet，Deployment会按照控制的速率将pod从旧的ReplicaSet移动到新的ReplicaSet中。</p>
<p>3.如果当前状态不稳定，回滚到之前的Deployment revision。每次回滚都会更新Deployment的revision。</p>
<p>4.扩容Deployment以满足更高的负载。</p>
<p>5.暂停Deployment来应用PodTemplateSpec的多个修复，然后恢复上线。</p>
<p>6.根据Deployment 的状态判断上线是否hang住了。</p>
<p>7.清除旧的不必要的ReplicaSet。</p>
<p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73g1pkdej30n209iq3t.jpg" alt></p>
<h3 id="1-3-3-DaemonSet"><a href="#1-3-3-DaemonSet" class="headerlink" title="1.3.3 DaemonSet"></a>1.3.3 DaemonSet</h3><p>DaemonSet保证在每个Node上都运行一个容器副本，常用来部署一些集群的日志、监控或者其他系统管理应用。k8s内部就启用了这个，一般运维监控才用到它。日志收集，系统监控等</p>
<p>系统程序，比如kube-proxy, kube-dns, glusterd, ceph等都是DaemonSet</p>
<h3 id="1-3-4-StatefulSet"><a href="#1-3-4-StatefulSet" class="headerlink" title="1.3.4 StatefulSet"></a>1.3.4 StatefulSet</h3><p>StatefulSet是为了解决有状态服务的问题（对应Deployments和ReplicaSets是为无状态服务而设计），我们后续讲完了K8s存储后，再回头来讲它的使用</p>
<h3 id="1-3-5-Job控制器"><a href="#1-3-5-Job控制器" class="headerlink" title="1.3.5 Job控制器"></a>1.3.5 <a href="https://www.cnblogs.com/caibao666/p/11207677.html" target="_blank" rel="noopener">Job控制器</a></h3><p>Job控制器用于调配pod对象运行一次性任务，容器中的进程在正常运行结束后不会对其进行重启，而是将pod对象置于completed状态。若容器中的进程因错误而终止，则需要依据配置确定重启与否，未运行完成的pod对象因其所在的节点故障而意外终止后会被重新调度。</p>
<p>job控制器对象有两种：</p>
<p>Ø 单工作队列的串行式job：即以多个一次性的作业方式串行执行多次作业，直至满足期望的次数</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73ga0ekej30n207omy1.jpg" alt> </p>
<p>运行后，pod的状态：</p>
<p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73gjq2zzj30n2042wfd.jpg" alt></p>
<p>查看pod的运行日志</p>
<p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73gmt8j3j30n20423zd.jpg" alt></p>
<p>Ø 多工作队列的并行式job：这种方式可以设置工作队列数，即作业数，每个队列仅负责运行一个作业。</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73hft8ahj30n2092abd.jpg" alt></p>
<p>此任务运行后，查看其执行的pod个数</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73hoa5btj30n209qdi4.jpg" alt> </p>
<h2 id="1-4-Pod的调度"><a href="#1-4-Pod的调度" class="headerlink" title="1.4 Pod的调度"></a>1.4 Pod的调度</h2><p>   在k8s中当定义某个Pod对象时，若没有特定调度规则设定，则k8s本身会调用GenericScheduler通过预选优选算法来为该Pod选择一个最优Node节点，即最终Node节点是谁是不确定的。例如，我们前面经常用一deployment的过程：</p>
<p>   比如这个创建: </p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73hv4qpgj30n2044gmo.jpg" alt></p>
<p>   查看其中一个pod的事件列表，第一步都是计算调度的assigned决定：</p>
<p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73i9g0pjj30n2038gmg.jpg" alt></p>
<p>   但在实际工作中，我们可能需要指向性地将某个Pod定向调度到某个Node中，K8s为我们准备了几种方式来实现这种需求。</p>
<h3 id="1-4-1-NodeName强制约束"><a href="#1-4-1-NodeName强制约束" class="headerlink" title="1.4.1 NodeName强制约束"></a>1.4.1 NodeName强制约束</h3><p>我们可以使用NodeName指定，来强制约束pod要在某个node上运行</p>
<p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73ieeq9ej30n209edh4.jpg" alt></p>
<p>运行查验</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73iiaok9j30n203ujs5.jpg" alt> </p>
<p>实际上，这种node的指定是强制的，是直接取消掉的k8s的调度计算的</p>
<p>查看pod的事件列表：</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73imloo0j30n202cwem.jpg" alt> </p>
<p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73iuwb20j30n2036t9j.jpg" alt></p>
<h3 id="1-4-2-NodeSelector定向调度"><a href="#1-4-2-NodeSelector定向调度" class="headerlink" title="1.4.2 NodeSelector定向调度"></a>1.4.2 NodeSelector定向调度</h3><p>   通过kubernetes的label-selector机制进行节点选择，由scheduler调度策略MatchNodeSelector进行label匹配，调度pod到目标节点，该匹配规则是强制约束，使用示例如下：</p>
<p>\1.   给目标node打上一些标签，示例如下：</p>
<p>kubectl label nodes work2 like=north</p>
<p>其实就是为work2节点加一个属性，key和value值都随意</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73j40sm6j30n2044q4d.jpg" alt> </p>
<p>删除这个属性，只需要将key紧接一个“-”字符即可</p>
<p>kubectl label nodes work2 like-</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73j9t5u6j30n2044gmy.jpg" alt> </p>
<p>\2.   在pod的定义加上nodeSelector设置（pod的偏向喜好）</p>
<p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73jfn87jj30n2090gml.jpg" alt></p>
<p>运行这个pod，看它是否能得偿所愿</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73jx73b5j30n202ijrw.jpg" alt></p>
<h3 id="1-4-3-NodeAffinity调度"><a href="#1-4-3-NodeAffinity调度" class="headerlink" title="1.4.3 NodeAffinity调度"></a>1.4.3 NodeAffinity调度</h3><p>   NodeSelector调度算法比较简单，只是调度pod到某个拥有特定标签的Node上。而现实世界复杂的多，我们需要的是一系列的策略来决定，于是NodeAffinity出场，扩展了策略</p>
<p>   NodeAffinity 亲和性有两种表达方式：</p>
<p>Ø RequiredDuringSchedulingIgnoredDuringExecution ：必须满足指定的规则才可以调度Pod到Node上，相当于硬限制。</p>
<p>Ø PreferredDuringSchedulingIgnoredDuringExecution：强调优先满足指定的规则，相当于软限制，并不强求。</p>
<p>示例：</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73jp22sbj30n20b0gn0.jpg" alt> </p>
<p>运行尝试，查验结果</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73kdmvymj30n202ijrv.jpg" alt> </p>
<p>PreferredDuringSchedulingIgnoredDuringExecution的用法，依次类推，希望你能举一反三。此外，此使用匹配语法灵活，你完全可以配出一系列实际效果，如pod节点的互斥性等等</p>
<h2 id="1-5-K8S的label作用"><a href="#1-5-K8S的label作用" class="headerlink" title="1.5 K8S的label作用"></a>1.5 K8S的label作用</h2><p>我们在上述的章节中，看到了k8s中一个特殊的存在：label。</p>
<p>   在这里特别强调一下：</p>
<p>   标签是一种简单却又功能强大的kubernetes特性，不仅可以组织pod，也可以组织所有其他的kubernetes资源，标签是可以附加到资源的任意键值对，用以选择具有该确切标签的资源，只要标签的key在资源内是唯一的，一个资源便可以拥有多个标签。</p>
<p>   k8s除了使用标签来控制pod的调度之外，还有两个功能，也是使用label来实现的。</p>
<p>   1.deploy控制器通过label找到对应控制的pods集群</p>
<p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73khnsgyj30n209i0tt.jpg" alt></p>
<p>​    2.Service通过label，来绑定port到对应的pods集群，从而提供稳定的服务</p>
<p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73kobde9j30n2082gmd.jpg" alt></p>
<h2 id="1-6-Pod的健康检查"><a href="#1-6-Pod的健康检查" class="headerlink" title="1.6 Pod的健康检查"></a>1.6 Pod的健康检查</h2><p>   Kubernetes会维持Pod的状态及个数，而Pod内容器失败后往往也会导致pod退出，这么看来，K8s在某种程度上已经帮我们保证了容器服务的安全性。但也有很多场景，仅仅这样远远不够，比如某个时候容器服务假死，或者容器服务已经出错但并未退出。这些情况k8s的策略是无能为力的。</p>
<p>   K8S提供了一处机制，来帮助我们来检查容器的健康的程度。</p>
<p>   健康检查（Health Check）用于检测您的应用实例是否正常工作，是保障业务可用性的一种传统机制，一般用于负载均衡下的业务，如果实例的状态不符合预期，将会把该实例“摘除”，不承担业务流量。Kubernetes中的健康检查使用存活性探针（liveness probes）和就绪性探针（readiness probes）来实现，service即为负载均衡，k8s保证 service 后面的 pod 都可用，是k8s中自愈能力的主要手段。</p>
<p>目前支持的探测方式包括：</p>
<p>·    HTTP</p>
<p>·    TCP</p>
<p>·    Exec命令</p>
<p>我们主要讲一下常见易用的Exec方式和Http方式</p>
<h3 id="1-6-1-通过exec方式做健康探测"><a href="#1-6-1-通过exec方式做健康探测" class="headerlink" title="1.6.1 通过exec方式做健康探测"></a>1.6.1 通过exec方式做健康探测</h3><p>   对于Exec探针，Kubernetes则只是在容器内运行命令。 如果命令以退出代码0返回，则容器标记为健康。 否则，它被标记为不健康。 </p>
<p>   当您不能或不想运行HTTP服务时，此类型的探针则很有用，但是必须是运行可以检查您的应用程序是否健康的命令。</p>
<p>   用法如以下示例：</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73lacp16j30n20bg75y.jpg" alt> </p>
<p>   测试如下：</p>
<p>创建pod</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73lpuwu4j30n2042gmh.jpg" alt></p>
<p>查看pod事件</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73lv9u6yj30n2048my9.jpg" alt> </p>
<p>可以看到，在容器刚启动的60秒内，服务是正常的。此时healthy文件也在容器里。但容器启动后60秒后，healthy文件自动被删除，此时liveness检测无法探测到healthy文件，于是触发K8S机制剔除掉服务，并重建容器。</p>
<h3 id="1-6-2-通过HTTP方式做健康探测"><a href="#1-6-2-通过HTTP方式做健康探测" class="headerlink" title="1.6.2 通过HTTP方式做健康探测"></a>1.6.2 通过HTTP方式做健康探测</h3><p>HTTP探针可能是最常见的自定义Liveness探针类型。 即使您的应用程序不是HTTP服务，您也可以在应用程序内创建轻量级HTTP服务以响应Liveness探针。 Kubernetes去访问一个路径，如果它得到的是200或300范围内的HTTP响应，它会将应用程序标记为健康。 否则它被标记为不健康。</p>
<p>httpGet配置项：</p>
<ul>
<li>host：连接的主机名，默认连接到pod的IP。你可能想在http header中设置”Host”而不是使用IP。</li>
<li>scheme：连接使用的schema，默认HTTP。</li>
<li>path: 访问的HTTP server的path。</li>
<li>httpHeaders：自定义请求的header。HTTP运行重复的header。</li>
<li>port：访问的容器的端口名字或者端口号。端口号必须介于1和65535之间。</li>
</ul>
<p>示例：</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73lzw7b8j30n20f076b.jpg" alt></p>
<p>运行此pod实例</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73m90ehbj30n202274m.jpg" alt> </p>
<p>查看事件列表</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73mckhqnj30n20420tq.jpg" alt> </p>
<p>此时，我们执行命令删除掉容器内的文件，看容器事件</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73mgzdwwj30n202k3yw.jpg" alt> </p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg73ml0yw7j30n2052wg3.jpg" alt></p>

        </div>
        <div id="post-footer">
            <div class="avatar">
                <img src="http://ww1.sinaimg.cn/large/006tNc79ly1g4jcpbkpo7j30u01407wj.jpg" alt="avatar">
                
                
                <a href="javascript:void(0)" class="donate fa">赠我一杯 &#128536;</a>
                
            </div>
            <ul class="author-profile-section">
                <li>
                  
                  Author:
                  
                    
                    <a href="/about.html">lill</a>
                </li>
                
                <li>Published Date: <span>2020-06-27  20:05:01</span></li>
                
                <li>Updated Date: <span>2020-06-27  20:08:21</span></li>
                
                <li class="post-category">
                    Categories:
                    
                    <a href="/categories/物理部署/">物理部署</a>
                    
                </li>
                <li class="post-tags">
                    Tags:
                    
                    <a href="/tags/k8s/">k8s</a>
                    
                </li>
                
                <li> License: <a href="https://creativecommons.org/licenses/by-nc-nd/3.0/" target="_blank">
知识共享署名-非商业性使用-禁止演绎 3.0 未本地化版本许可协议（CC BY-NC-ND 3.0）
</a></li>
                
            </ul>
            <div id="donate-wrap">
                
                
                
                <img src="http://ww3.sinaimg.cn/large/006tNc79ly1g4j3v2hrrjj30a00fk750.jpg" alt="支付宝付款" class="donate-img">
                
                <img src="http://ww2.sinaimg.cn/large/006tNc79ly1g4jc3z12itj30h90no0tp.jpg" alt="微信付款" class="donate-img">
                
                
            </div>
        </div>
    </article>
    <div class="article-nav">
        
        
        <a href="/2020/06/20/k8s-2/" class="next-post fa">Kubernetes 集群搭建</a>
        
    </div>
    
    <div id="comments">
        

<script>
  gitment.render(document.getElementById("comments"));
</script>



    </div>
    
</div>


    </div>
    <footer id="footer">
    
    <div class="social">
        
        <a href="https://github.com/EllenJack/ellenjack.github.io.git" class="fa fa-free-code-camp" target="_blank" title="freecodecamp"></a>
        
        <a href="https://github.com/EllenJack/ellenjack.github.io.git" class="fa fa-github" target="_blank" title="Follow me~"></a>
        
    </div>
    
    <div>
        
        <a href="/" class="copyright-links">lill</a>&copy;2015 - 2022.All Rights
        Reserved.
    </div>
    <p>Powered by <a href="https://hexo.io" class="copyright-links" target="_blank">Hexo</a> | Theme by <a href="https://github.com/GeekaholicLin" class="copyright-links" target="_blank">GeekaholicLin</a>
    </p>
    
</footer>

</div>
    <ul id="tools">
    <li class="totop-btn fa fa-angle-up"></li>
    <li class="exchange-btn fa fa-exchange"></li>
  
    <li class="toc-btn fa fa-list-ul"></li>
    
    

    
</ul>
<p id="process"></p>
<div id="search-overlay">
    <div class="search-area-wrap">
        <div id="search-area">
            <div class="input-wrap focus">
                <i class="fa fa-search" aria-hidden="true"></i>
                <input id="search-input" autofocus autocomplete="off" type="text" placeholder="search this website...">
            </div>
            <ul id="search-result">
                <li class="load-first"><i class="fa fa-spinner fa-pulse"></i></li>
            </ul>
        </div>
    </div>
</div>

    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-kubectl的命令用法"><span class="toc-number">1.</span> <span class="toc-text">1.1 kubectl的命令用法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1-kubectl-run，创建一个应用程序"><span class="toc-number">1.1.</span> <span class="toc-text">1.1.1 kubectl run，创建一个应用程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-2-探究pod详情："><span class="toc-number">1.2.</span> <span class="toc-text">1.1.2 探究pod详情：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-3-暴露服务到外网"><span class="toc-number">1.3.</span> <span class="toc-text">1.1.3 暴露服务到外网</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-4-服务的伸缩"><span class="toc-number">1.4.</span> <span class="toc-text">1.1.4 服务的伸缩</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-5-服务的在线升级与回滚"><span class="toc-number">1.5.</span> <span class="toc-text">1.1.5 服务的在线升级与回滚</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-YAML文件管理资源"><span class="toc-number">2.</span> <span class="toc-text">1.2 YAML文件管理资源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-资源清单的格式"><span class="toc-number">2.1.</span> <span class="toc-text">1.2.1 资源清单的格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-创建deployment"><span class="toc-number">2.2.</span> <span class="toc-text">1.2.2 创建deployment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-3-扩容伸缩"><span class="toc-number">2.3.</span> <span class="toc-text">1.2.3 扩容伸缩</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-4-获取资源的apiVersion版本及资源配置的帮助"><span class="toc-number">2.4.</span> <span class="toc-text">1.2.4 获取资源的apiVersion版本及资源配置的帮助</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-5-使用service提供外部访问"><span class="toc-number">2.5.</span> <span class="toc-text">1.2.5 使用service提供外部访问</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-Pod控制器-kube-controller-manager"><span class="toc-number">3.</span> <span class="toc-text">1.3 Pod控制器(kube-controller-manager)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-1-ReplicaSets控制器"><span class="toc-number">3.1.</span> <span class="toc-text">1.3.1 ReplicaSets控制器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-2-Deployment控制器"><span class="toc-number">3.2.</span> <span class="toc-text">1.3.2 Deployment控制器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-3-DaemonSet"><span class="toc-number">3.3.</span> <span class="toc-text">1.3.3 DaemonSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-4-StatefulSet"><span class="toc-number">3.4.</span> <span class="toc-text">1.3.4 StatefulSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-5-Job控制器"><span class="toc-number">3.5.</span> <span class="toc-text">1.3.5 Job控制器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-Pod的调度"><span class="toc-number">4.</span> <span class="toc-text">1.4 Pod的调度</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-1-NodeName强制约束"><span class="toc-number">4.1.</span> <span class="toc-text">1.4.1 NodeName强制约束</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-2-NodeSelector定向调度"><span class="toc-number">4.2.</span> <span class="toc-text">1.4.2 NodeSelector定向调度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-3-NodeAffinity调度"><span class="toc-number">4.3.</span> <span class="toc-text">1.4.3 NodeAffinity调度</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-K8S的label作用"><span class="toc-number">5.</span> <span class="toc-text">1.5 K8S的label作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-6-Pod的健康检查"><span class="toc-number">6.</span> <span class="toc-text">1.6 Pod的健康检查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-1-通过exec方式做健康探测"><span class="toc-number">6.1.</span> <span class="toc-text">1.6.1 通过exec方式做健康探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-2-通过HTTP方式做健康探测"><span class="toc-number">6.2.</span> <span class="toc-text">1.6.2 通过HTTP方式做健康探测</span></a></li></ol></li></ol>




<script src="/js/search.js"></script>
<script type="text/javascript">
    //theme config datas
    var copyrightObj = {};
    copyrightObj.enable = 'true';
    copyrightObj.triggerCopyLength = '200';
    copyrightObj.appendText = '商业转载请联系作者获得授权,非商业转载请注明出处 © example';
    var leancloudObj = {};
    leancloudObj.enable = 'false';
    leancloudObj.className = 'BlogCounter';
    leancloudObj.limits = '10';
</script>
<script type="text/javascript">
    var search = {};
    var search_path = "search.xml";
    if (!search_path) {
        search_path = "search.xml";
    }
    search.path = "/" + search_path;
    search.func =  _ajax.init();
</script>
<script src="/js/app.js"></script>


</body>
</html>