---
title: Kubernetes 集群搭建
date: 2020-06-20 17:09:21
tags:
- k8s
category:
- 物理部署
---
## 1.1 环境准备

本次教程，使用docker 18.09.9和kubelet-1.16.4，要求centos7.6以上版本

![](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvdlpy87j30ig020jrp.jpg)                               

### 1.1.1 关闭selinux

查看selinux是否关闭

 ![](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvg0j2d4j30hq01yaa7.jpg)

先设置临时关闭

![image-20200620171455330](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvg7256sj30i402owhm.jpg) 

永久关闭

![image-20200620171505161](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvgetzz7j30n205gn7d.jpg)

### 1.1.2 关闭swap

**k8s** **要求系统关闭，否则安装过程会报错**

**查看系统是否关闭了swap**

![](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvgl1pomj30n2090wgz.jpg)

 

 

**临时禁用：swapoff -a**

![image-20200620171529524](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvgxptgyj30n206qgy6.jpg) 

**永久禁用：sed -i.bak '/swap/s/^/#/' /etc/fstab  ##** **注释掉swap** **那一行**

**作用就是修改/etc/fstab** **配置为如下：**

![](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvi8kvmbj30n2070jsk.jpg) 

### 1.1.3 配置ip_forward转发

ip_forward 配置文件当前内容为0，表示禁止数据包转发，将其修改为1表示允许

echo "1" > /proc/sys/net/ipv4/ip_forward 

 ![](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvihwb0tj30n200ywem.jpg)

### 1.1.4 更新yum源

为了一次性配置好下载源，我们一次性修改好centos7软件源，docker源，k8s源

先清除掉系统自带配置

![image-20200620171718159](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvis58y4j30n208m7kk.jpg) 

下载centos7的源和docker源

wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo

wget -P /etc/yum.repos.d/ http://mirrors.aliyun.com/repo/epel-7.repo 

wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

结果如下：

 ![image-20200620171725234](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvitlxcsj30n203qtdw.jpg)

配置k8s源

cat <<EOF > /etc/yum.repos.d/kubernetes.repo

[kubernetes]

name=Kubernetes

baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64

enabled=1

gpgcheck=0

EOF

 ![image-20200620171733628](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvj08i5hj30n206wdph.jpg)

刷新yum缓存

 ![image-20200620171742973](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvj5bxivj30n207u11u.jpg)

 

 

### 1.1.5 安装docker

docker使用版本 18.09.9

yum install docker-ce-18.09.9 docker-ce-cli-18.09.9 containerd.io -y

 ![image-20200620171750006](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvj83wunj30n2048jum.jpg)

k8s运行要求docker的--cgroup-driver=systemd

 ![image-20200620171755853](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvjcgvr7j30n203kgps.jpg)

启动docker并设置开机启动

systemctl enable docker &&  systemctl start docker

![image-20200620171801283](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvjfcu1fj30n201wgoz.jpg) 

### 1.1.6 安装k8s组件：

yum install -y kubelet-1.16.4 kubeadm-1.16.4 kubectl-1.16.4

![image-20200620171810297](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvjm1douj30n2044af3.jpg) 

 ![image-20200620171818555](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvjqm69uj30n203eq6w.jpg)

设置开机启动：systemctl enable kubelet && systemctl start kubelet

![image-20200620171823592](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvjt4jonj30n200y40q.jpg) 

添加kubectl上下文到环境中

echo "source <(kubectl completion bash)" >> ~/.bash_profile

source ~/.bash_profile

在家目录中，配置生效

 ![image-20200620171832144](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvjy5g0jj30n201kq5c.jpg)

 

### 1.1.7 内核参数修改

k8s网络一般使用flannel，该网络需要设置内核参数bridge-nf-call-iptables=1

添加参数配置文件：

![image-20200620171839612](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvk431p7j30j402on15.jpg) 

执行：sysctl -p /etc/sysctl.d/k8s.conf

 ![image-20200620171846335](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvk7trb6j30n202kn1m.jpg)

 

至此，环境准备工作完毕

#### 1.1.7.1内核参数修改失败常见问题

有些系统执行sysctl -p /etc/sysctl.d/k8s.conf会报异常，一般是因为

修改这个参数需要系统有br_netfilter模块

 

使用lsmod |grep br_netfilter命令，查看系统里是否有br_netfilter模块

 ![image-20200620171855653](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvkd5ry2j30n2018gnt.jpg)

 

**新增br_netfilter** **模块:**

![image-20200620171906349](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvkjxhxnj30n2024jup.jpg) 

**上述方式重启后无效。需要配置系统启动加载脚本使其永久生效：**

Ø **先加开机启动动作**

**vi /etc/rc.sysinit**

 ![](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvmo0hxhj30jw04074w.jpg)

Ø **再做加载模块动作**

**vi /etc/sysconfig/modules/br_netfilter.modules**

![](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvmunhggj30n201wdg2.jpg) 

Ø **再增加执行权限**

![](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvn48zfjj30n201e74j.jpg)

 

 

## 1.2 Master节点配置

### 1.2.1 Master节点初始化

kubeadm init --image-repository registry.aliyuncs.com/google_containers --kubernetes-version v1.16.4 --pod-network-cidr=10.244.0.0/16

这一步，如果出现下面错误，则是前面的2.1.6节点内核没有配置

![](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvndb9jsj30n201oaaj.jpg) 

正常情况，如下：

 ![](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvnobl3vj30n202gjs0.jpg)

![](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvnser2qj30n207kgnf.jpg) 

出现这一步，恭喜你，已经成功一大半了！

接下来，我们按它的提示执行操作

 ![](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvo10v5oj30n201gt8x.jpg)

### 1.2.2 添加flannel的网络

按照master的提示，我们接下来应该配置一个pod network。

但是，因为国内网络不通的原因，此操作无法完成。

你只能选择定制的文件来完成,下载地址: https://ellen566.cowtransfer.com/s/afff2c7b40f942 取件码：54b6hk

上传文件到你的系统后，使用下面命令

kubectl apply -f flannel.yml 

 ![](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvo8cw0xj30n206u76e.jpg)

至此，大功告成

### 1.2.3 查看集群

查看你k8s集群

 ![](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvoetaxaj30n2028jrr.jpg)

 

## 1.3 work节点初始化

**work** **节点的配置，相对master** **来说简单许多，只需要规划好节点的名称即可**

 

### 1.3.1 设置机器名

设置一个机器名为work1

![](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvoj5yjkj30ki01cq32.jpg) 

 

 

配置对应的ip

![](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvop2fj3j30n202w74y.jpg) 

### 1.3.2 加入集群

在要加入的工作节点机器上，执行master 初始化时提示的join语句，即加到master的管辖内

![](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvoudgkrj30n204s75b.jpg) 

**回到master** **节点再次查看集群**

![](https://tva1.sinaimg.cn/large/007S8ZIlly1gfyvoyyhiaj30n202674l.jpg)

 



 
